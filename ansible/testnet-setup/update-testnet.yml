- hosts:
  - rchain-testnet
  roles:
  - docker-ce

  tasks:

  - name: Stop running rnode
    script: ./stop-container
    register: stop_rnode
    changed_when: "'Stopping' in stop_rnode.stdout"

  - name: Clean RChain data
    file: state=absent path={{ item }}
    with_items:
    - /var/lib/rnode/casper-block-store
    - /var/lib/rnode/genesis
    - /var/lib/rnode/rspace

  - name: Create data directory
    file: state=directory path=/var/lib/rnode

  - name: Copy files
    copy: src={{ item }} dest=/var/lib/rnode/ mode=preserve
    with_items:
    - bonds.txt
    - wallets.txt
    - autopropose

  - name: Start bootstrap node
    when: kind == 'bootstrap'
    docker_container:
      name: rnode
      image: rchain/rnode:{{ rel }}
      pull: yes
      #recreate: yes
      volumes:
      - /var/lib/rnode:/var/lib/rnode
      command: >
        --grpc-port 40401
        --grpc-port-internal 40402
        run
        --standalone
        --has-faucet
        --port 40400
        --http-port 40403
        --kademlia-port 40404
        --bonds-file /var/lib/rnode/bonds.txt
        --wallets-file /var/lib/rnode/wallets.txt
      ports:
      - 40400:40400
      - 127.0.0.1:40401:40401
      - 127.0.0.1:40402:40402
      - 127.0.0.1:40403:40403
      - 40404:40404

  - name: Wait for bootstrap node to listen
    when: kind == 'bootstrap'
    wait_for:
      host: 0.0.0.0
      port: 40400
      delay: 60

  - name: Start validator node
    when: kind != 'bootstrap'
    docker_container:
      name: rnode
      image: rchain/rnode:{{ rel }}
      pull: yes
      #recreate: yes
      volumes:
      - /var/lib/rnode:/var/lib/rnode
      command: >
        --grpc-port 40401
        --grpc-port-internal 40402
        run
        --bootstrap {{ bootstrap }}
        --validator-private-key {{ pk }}
        --port 40400
        --http-port 40403
        --kademlia-port 40404
        --bonds-file /var/lib/rnode/bonds.txt
        --wallets-file /var/lib/rnode/wallets.txt
      ports:
      - 40400:40400
      - 127.0.0.1:40401:40401
      - 127.0.0.1:40402:40402
      - 127.0.0.1:40403:40403
      - 40404:40404

  - name: Wait for validator node to listen
    when: kind != 'bootstrap'
    wait_for:
      host: 0.0.0.0
      port: 40400
      delay: 10

  - name: Start auto propose
    when: autopropose is defined
    docker_container:
      name: autopropose
      image: rchain/rnode:{{ rel }}
      pull: yes
      #recreate: yes
      network_mode: host
      volumes:
      - /var/lib/rnode:/var/lib/rnode
      entrypoint: /var/lib/rnode/autopropose

  - name: logspout is running
    docker_container:
      name: logspout
      image: gliderlabs/logspout
      pull: yes
      volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      ports:
      - 8181:80

# vim:ft=yaml.ansible:
